# 概要
このファイルは、データベース設計において「アドホックな集計キー」をテーブルに追加する方法と、その利用について解説しています。

# 8-4 アドホックな集計キー
「アドホックな（場当たり的な）集計キー」とは、特定の集計や分析のために一時的に、あるいは特定用途のために導入されるキーのことです。

## 集計キーを追加
例として、都道府県テーブルに「地方コード」という集計キーを追加するケースが示されています。

| 県コード | 県名   | 人口 (万人) | 地方コード |
| :------- | :----- | :---------- | :--------- |
| 01       | 北海道 | 550         | 01         |
| 02       | 青森   | 130         | 01         |
| 03       | 岩手   | 133         | 01         |
| 22       | 静岡   | 370         | 02         |
| 23       | 愛知   | 740         | 02         |
| 24       | 三重   | 185         | 02         |
| 36       | 徳島   | 78          | 03         |
| 37       | 香川   | 99          | 03         |

この「地方コード」は、データ自体には存在しないが、特定の地域ごとにデータを集計するために便宜的に追加されたキーです。

## 課題
このようなアドホックな集計キーをトランザクションテーブルに直接追加すると、いくつかの課題が発生する可能性があります。

- **メンテナンスの複雑化**: 集計ロジックの変更があるたびにテーブル構造やデータ定義を変更する必要が生じ、メンテナンスが煩雑になる可能性があります。
- **パフォーマンスへの影響**: 大規模なテーブルの場合、この種のキーを追加する操作は、データベースのパフォーマンスに大きな影響を与える可能性があります。

## 解決策
以下の解決策があると考えられています。
- 「ビュー（View）」の利用
- キーを別テーブルに分離すること（マスターテーブルを用意する）
- CASE式を用いて、SELECTのSQLで地方コードを追加する

### 仮想ビュー
- オリジナルテーブルのデータを直接変更する代わりに、仮想ビューを作成し、そのビューの中でアドホックな集計キーを定義します。
- これにより、オリジナルテーブルのアクセスやコストは変わらず、パフォーマンスに影響を与えずに柔軟な集計を行うことが可能になります。
- ビューは、以下のような`CASE WHEN`文を使って作成することができます。

```sql
SELECT 県コード, 県名, 人口 (万人),
       CASE WHEN 県コード IN ('01', '02', '03') THEN '01'
            WHEN 県コード IN ('22', '23', '24') THEN '02'
            WHEN 県コード IN ('36', '37') THEN '03'
            ELSE NULL END AS 地方コード
FROM 都道府県;