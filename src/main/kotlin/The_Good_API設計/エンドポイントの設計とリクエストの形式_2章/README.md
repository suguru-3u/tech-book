# 概要

このページはオライリージャパンの「Web API The Good Parts」の2章-エンドポイントの設計とリクエストの形式を読んで、学んだことメモ変わりに記載しているページです。

# 1.どんなAPIを作成したいのか考え整理しよう

API設計のSTEP1として、どんなAPIを作成したいのか考えましょう。

DBにアクセスしてデータを取得するのか、外部APIにリクエストするのか、色々な用途があると思います。<br>
ユーザーがAPIをどう使用するのかユースケースやアプリの画面と遷移の関係も一緒に考えるとよりイメージが出てくると思います。

作成したいAPIのアイディアが出てきたら、箇条書きに書き出してみましょう。

# 2.APIのエンドポイント(URL)を考える

APIでやりたいこと・必要な機能を整理したら、そのAPIにアクセスするURLを考えましょう。<br>
以下のようなURLのこと。

http://api.example.com/products/123

作成する上で、**覚えやすくどんなURLなのかひと目でわかる** ことを意識して考えるようにしましよう。意識する上で大切なことを下記に記載します。

- 短く入力しやすい
- 人間が読んで理解できる
- 大文字小文字が混在しない、基本小文字を使用する
- 改造しやすい
- サーバ側のアーキテクチャが反映されていない
- ルールが統一されている
- 複数形の名詞を利用する
- 利用する単語に気をつける
- スペースやエンコードを必要とする文字を使用しない
- 単語を繋げる必要がある場合は、ハイフンを利用すること

大体の項目は理解できると思いますが、一部補足を記載します。

## 大文字小文字が混在しない、基本小文字を使用する

基本的に他の会社では、URLに大文字があると404エラーをレスポンスするところが多い。

## 改造しやすい

ここでいう改造とはURLを修正することで別のURLにすることができることを意味します。
例えば、http://api.example.com/v1/todos/1 このURLの末尾の1を変更するだけで違うtodoにアクセスすることができることがイメージできると思います。
これが100までは、http://api.example.com/v1/todos/1 でアクセスできても、100以降はhttp://api.example.com/v1/todos2/101
でないとアクセスできないと<br>
使用する目線では使いづらく思わぬ事故が発生してしまう可能性があります。

※セキュリティ的には、権限や他人の情報は見れないように制御した方がいい！

## サーバ側のアーキテクチャが反映されていない

これはURLからアーキテクチャがわかるようにしないことを指しています。
例えば、http://api.example.com/v1/todos/edit.php?todo=1 このURLではphpで作成されていることがわかってしまうと思います。
アーキテクチャがURLからわかってしまうとセキュリティに危険が発生する可能性がありますので、やめた方がいいでしょう。

## ルールが統一されている

実際に業務で設計する際には、すでにAPIがある場合がほとんどだと思います。
その場合、他のAPIやドメインに合わせたURLにすることで統一感が出て使いやすいAPIになります。

※もちろん過去の設計がイけてない可能性もあるので、よく考えることも必要。

# 3.HTTPメソッドも一緒に考えよう！

URLを考える際に、一緒にHTTPメソッドも考えましょう。
イメージとして、URLは名詞でHTTPメソッドは動詞と考えるとどのHTTPメソッドにすればいいのか考えやすいと思います。

また一部環境では、GETとPOSTしか使用できない場合があります。 <br>
その場合、リクエストヘッダ「X-HTTP-Method-Override」か「_method」というパラメータを使用して、POSTとしてリクエストを受け付けてAPI
側で本来のHTTPメソッドと変換してあげるやり方もあります。この方法はフレームワークやライブラリなどもサポートしている。

| メソッド名  | 説明           | 補足              |
|--------|--------------|-----------------|
| GET    | リソースの取得      | URLを取得          |
| POST   | リソースの新規登録    | URLに新しいデータを追加する |
| PUT    | 既存リソースの更新    | URLのデータを置き換える   |
| DELETE | リソースの削除      | URLのデータを削除する    |
| PATCH  | リソースの一部変更    | URLのデータを一部更新する  |
| HEAD   | リソースのメタ情報の取得 |                 |

# APIのエンドポイント(URL)設計の実施

上記URLとHTTPメソッドの説明から今回のサンプルのTodoアプリのURLを設計していきたいと思います。

| 目的          | URL                                           | メソッド      |
|-------------|-----------------------------------------------|-----------|
| ユーザーの登録     | http://api.example.com/v1/users               | POST      |
| ユーザーの詳細情報取得 | http://api.example.com/v1/users/:id           | GET       |
| ユーザーの編集     | http://api.example.com/v1/users/:id           | PUT/PATCH |
| Todoの取得・検索  | http://api.example.com/v1/users/:id/todos     | GET       |
| Todoの登録     | http://api.example.com/v1/users/:id/todos     | POST      |
| Todoの詳細情報取得 | http://api.example.com/v1/users/:id/todos/:id | GET       |
| Todoの編集     | http://api.example.com/v1/users/:id/todos/:id | PUT/PATCH |
| Todoの削除     | http://api.example.com/v1/users/:id/todos/:id | DELETE    |

※URLのドメインは適当に記載しています

上記のURLを設計してみました。
URLは同じでも異なるHTTPメソッドを使用することで、一つだけでなく様々な表現を行うことができるようになります。URLをうまく使えていると思います。
ただし今のURLではuserのidを適当な値を入れると赤の他人のTodoも操作できてしまうので、別途セキュリティを考える必要があります。（アクセストークンやセッション）

さてここまで大体の設計ができたと思いますが、Todoの取得・検索のクエリパラメータの設計を考える必要があります。

## 検索とクエリパラメータの設計

クエリパラメーターを考えるあたり、対象のURLを確認します。
http://api.example.com/v1/users/:id/todos

上記のURLにクエリパラメータを設計していきますが、どんなパラメータを設定するべきでしょうか？
今回の例のTodoアプリでは、一度に表示する数とどこから値を取得するのかがパラメータとして必要そうです。
もしこの二つのパラメータがない場合、Todo全件取得することになってしまうため、データが大きくなった場合にパフォーマンス上で問題が発生する可能性があります。
そのため、上記パラメータを持ちいる必要が出てきます。クエリパラメータを追加して例を記載します。
http://api.example.com/v1/users/:id/todos?limit=50&page=1

limitはデータの取得数、pageは取得する位置を表しています。
クエリパラメータの名前は各社色々な名前を使用しているので、調べてみるのがいいと思います。

さて、これでクエリパラメータの設計は完成だと思いますが、実はまだ問題&考えることが残っています...

まず一つ目がパフォーマンスの問題です。
先程パフォーマンスの問題が解決した的なことを記載しましたが、実は上記のやり方では別の方面でパフォーマンスの問題が発生してしまいます。それはpageのパラメータからDBから値を取得する際に、SQLでoffsetとlimitを使用してデータの位置を取得しようとすると、データの数が増えるにつれて速度が遅くなってしまうことがあることです。
offsetとlimitではデータの一番最初から数えてデータの位置を数えるため問題が発生してしまいます。（相対位置）
そこで、このIDから50件のデータを取得してほしいといった形に修正することで、わざわざはじめからデータの数を数える必要はなくなり問題を解決することができます。（絶対位置）
そのためには、クエリパラメーターに絶対位置を追加し修正します。これで問題を解決することができました。
http://api.example.com/v1/users/:id/todos?limit=50&maxId=300

二つ目は絞り込みを行うためのパラメータです。
複数のパラメータを使用可能にするのか、絞り込みのためのパラメータがない場合はエラーを返すのか考える必要があります。各社決まった絞り込みのためのパラメータは存在しないので、ここも調べてみるのがいいと思います。
ここでも検索クエリを使用した例を記載してみます。
http://api.example.com/v1/users/:id/todos?title=test&category=test&limit=50&maxId=300

以上でクエリパラメータの設計を完了したいと思います。